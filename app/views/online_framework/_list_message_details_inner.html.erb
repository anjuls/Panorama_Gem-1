<%
   def link_errors(rec, value)
     if value.to_i == 0
       value.to_s
     else
       my_ajax_link_to(value,
             url_for(:action => "show_oferrormessage",
                     :id_ofmessagetype => @ofmessagetype.id.to_i,
                     :time_selection_start  => rec.timestamp.strftime(session[:database].strftime_format_with_minutes),
                     :timeSlice  => @timeSlice,
                     :update_area => @update_area),
           :title=>"Anzeige der Fehlermeldungen des Messagetypes und Zeitraumes (unterhalb)")
     end
   end

   # Abfakturieren der Inhalte von Queue-Length, @start_queue_length enth채lzt den Initialwert
   def currentQueueLength(rec)
     @start_queue_length = @start_queue_length-rec.incoming.to_i+rec.firsttrysuccess.to_i+rec.retrysuccess.to_i+rec.finalerror.to_i
     if @start_queue_length < 0
       0
     else
       @start_queue_length
     end
   end

   def elapsed(rec)
     ((rec.firsttry.to_i+rec.retries.to_i) == 0) ? "?" : formattedNumber(rec.elapsedmilliseconds.to_i/(rec.firsttry.to_i+rec.retries.to_i), 2)
   end

   def msg_per_bulkgroup(rec)
     (rec.bulkgroups == 0) ? "?" : formattedNumber((rec.firsttry+rec.retries).to_f / rec.bulkgroups, 2)
   end

   def elapsed_per_bulkgroup(rec)
     (rec.bulkgroups.to_i == 0) ? "?" : formattedNumber(rec.elapsedmilliseconds.to_i/1000.0/rec.bulkgroups.to_i, 2)
   end

  column_options =
  [
    {:caption=>"Timestamp",         :data=>proc{|rec| localeDateTime(rec.timestamp)},        :title=>"Beginn des Zeitraumes der Messwerte", :plot_master=>true, :plot_master_time=>"milliSec1970(rec.timestamp)" },
    {:caption=>"Incoming",          :data=>proc{|rec| formattedNumber(rec.incoming)},        :title=>"Anzahl der eingehenden Messages",     :align=>'right'},
    {:caption=>"First Try Success", :data=>proc{|rec| formattedNumber(rec.firsttrysuccess)}, :title=>"Anzahl der beim ersten Versuch erfolgreich verarbeiteten Messages",     :align=>'right'},
    {:caption=>"Retry Success",     :data=>proc{|rec| formattedNumber(rec.retrysuccess)}, :title=>"Anzahl der nach Wiederholung erfolgreich verarbeiteten Messages",     :align=>'right'},
    {:caption=>"Final Errors",      :data=>proc{|rec| link_errors(rec, formattedNumber(rec.finalerror))}, :title=>"Anzahl der nach x Wiederholungen als fehlerhaft markierten Messages",     :align=>'right'},
    {:caption=>"Queue Length",      :data=>proc{|rec| formattedNumber(currentQueueLength(rec))}, :title=>"Anzahl wartende Messages in Queue an Beginn des Zeitraumes (tendentiell)",     :align=>'right'},
    {:caption=>"Divide and Conquer",:data=>proc{|rec| formattedNumber(rec.divideandconquer)},:title=>"Anzahl der Divide&Conquer-Vorg채nge nach Persist-Fehlern",     :align=>'right'},
    {:caption=>"Retry Transaction", :data=>proc{|rec| formattedNumber(rec.retrytx)},         :title=>"Anzahl Neustart der Verarbeitung von Tx-Gruppen nach Aussteuern fehlerhafter Messages bei handleMessage",     :align=>'right'},
    {:caption=>"First Try",         :data=>proc{|rec| formattedNumber(rec.firsttry)},        :title=>"Anzahl der erstmaligen Berarbeitungsversuche von Messages",     :align=>'right'},
    {:caption=>"Retry",             :data=>proc{|rec| formattedNumber(rec.retries)},         :title=>"Anzahl der wiederholten Berarbeitungsversuche von Messages",     :align=>'right'},
    {:caption=>"First Try Error",   :data=>proc{|rec| link_errors(rec, formattedNumber(rec.firsttryerror))}, :title=>"Anzahl der nach erstem Verarbeitungsversuch wegen Fehler in Queue zur체ckgestellten Messages",     :align=>'right'},
    {:caption=>"Retry Error",       :data=>proc{|rec| link_errors(rec, formattedNumber(rec.retryerror))}, :title=>"Anzahl der nach wiederholtem Verarbeitungsversuch wegen Fehler in Queue zur체ckgestellten Messages",     :align=>'right'},
    {:caption=>"Elapsed total",     :data=>proc{|rec| formattedNumber(rec.elapsedmilliseconds.to_i/1000)}, :title=>"Verarbeitungszeit total im Betrachtungszeitraum in Sekunden",     :align=>'right'},
    {:caption=>"Elapsed / Msg",     :data=>proc{|rec| elapsed(rec)},                         :title=>"Verarbeitungszeit je Message in Millisekunden",     :align=>'right'},
    {:caption=>"Bulk-Groups",       :data=>proc{|rec| formattedNumber(rec.bulkgroups)},      :title=>"Anzahl durch Worker verarbeitete Bulk-Groups",     :align=>'right'},
    {:caption=>"Msg. / Bulkgroup",  :data=>proc{|rec| msg_per_bulkgroup(rec)},               :title=>"Durchschn. Anzahl Messages je Bulkgroup",     :align=>'right'},
    {:caption=>"Elapsed / Bulkgroup",:data=>proc{|rec| elapsed_per_bulkgroup(rec)},          :title=>"Verarbeitungszeit je Bulkgroup in Sekunden",     :align=>'right'},
  ]

%>

<%=

    caption = "Details zu ID_OFMessageType=#{@ofmessagetype.id} : #{@ofmessagetype.name} Domain=#{@ofmessagetype.domain.name} von #{@time_selection_start} bis #{@time_selection_end}#{" RAC-Instance=#{@instance}" if @instance}"
    caption << "<br>#{@ofmessagetype.description}"
    caption << "<br>ID_Application=#{@ofmessagetype.id_application} : Verantwortlich: #{@ofmessagetype.application.developmentteam ? @ofmessagetype.application.developmentteam.name: ""}"

    gen_slickgrid(@history, column_options, {
            :plot_area_id => "list_message_detail_inner_plot_area",
            :max_height => 450,
            :caption => caption.html_safe
    })
%>

<div id="list_message_detail_inner_plot_area" style="float:left; width:100%;">
</div>

